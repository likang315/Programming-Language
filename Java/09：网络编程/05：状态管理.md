### 状态管理

------

[TOC]

##### 01：概述

- 最初，HTTP被设计为无状态，面向请求/响应的协议，对于跨越几个逻辑相关的请求/响应交换的有状态会话没有特殊规定。随着HTTP协议的普及和采用越来越多的系统开始将其用于应用程序，它从未打算用于电子商务应用程序的传输。因此，对状态管理的支持成为必要。

##### 02：HTTP cookies

- HTTP cookie是HTTP代理和目标服务器**可以交换以维护会话的令牌**或短状态信息包。 
- HttpClient使用 **Cookie接口** 表示抽象cookie令牌，键值对存储；

##### 03：Cookie 规范

- **CookieSpec** 接口表示cookie管理规范。 cookie管理规范应强制执行：
  - 解析Set-Cookie标头的规则。
  - 解析cookie的验证规则。
  - 格式化给定主机，端口和原始路径的Cookie标头。
- HttpClient 附带了几个 CookieSpec 实现：
  - **Standard strict:** 状态管理策略符合RFC 6265第4节定义的行为良好的配置文件的语法和语义。
  - **Standard:** 状态管理策略符合RFC 6265定义的更宽松的配置文件，第4节旨在与不符合良好行为的配置文件的现有服务器进行互操作。

##### 04：选择Cookie 策略

- ```java
  RequestConfig globalConfig = RequestConfig.custom().setCookieSpec(CookieSpecs.DEFAULT).build();
  CloseableHttpClient httpclient = HttpClients.custom().setDefaultRequestConfig(globalConfig)
          .build();
  ```

##### 05：Cookie 持久性

- HttpClient 可以与**实现CookieStore接口的持久性**，cookie存储的任何物理表示一起使用；

- **BasicCookieStore** 是CookieStore 的默认实现；

-  当容器对象**被垃圾收集时**，存储在BasicClientCookie对象中的Cookie将丢失。 如有必要，用户可以提供更复杂的实现。

- 设置一个http cookie存储器

  - ```java
    // Create a local instance of cookie store
    CookieStore cookieStore = new BasicCookieStore();
    // Populate cookies if needed
    BasicClientCookie cookie = new BasicClientCookie("name", "value");
    cookie.setDomain(".mycompany.com");
    cookie.setPath("/");
    cookieStore.addCookie(cookie);
    // Set the store  
    CloseableHttpClient httpclient = HttpClients.custom().setDefaultCookieStore(cookieStore).build();
    ```





